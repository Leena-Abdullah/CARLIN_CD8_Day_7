---
title: "Figure 2 Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
##loading packages
library(Seurat)
library(SeuratWrappers)
library(SeuratDisk)
library(dplyr) 
library(ggplot2)

##opening the object from figure 1
mcv=readRDS(file = '/Users/leenaabdullah/Dropbox (Huang Lab)/Leena and Yina/CARLIN Lineage Tracing/carlin experiments/06082022 vsv-ova infection/stuff for the paper/fig 1/mcv_fig1.rds') 
```

```{r}
##code modified from https://smorabit.github.io/tutorials/8_velocyto/
##set directory to figure 2 folder
dir2='~/Dropbox (Huang Lab)/Leena and Yina/CARLIN Lineage Tracing/carlin experiments/06082022 vsv-ova infection/stuff for the paper/fig 2/'
###Step -1: Convert data from Seurat to Python / anndata
# save metadata table:
mcv$barcode <- colnames(mcv)
mcv$UMAP_1 <- mcv@reductions$umap@cell.embeddings[,1]
mcv$UMAP_2 <- mcv@reductions$umap@cell.embeddings[,2]

# ##save partition info and metadata
# mcv[['group']]='0'
# metadata=mcv@meta.data
# for (i in 1:nrow(metadata)){
#     if (metadata[i,]$seurat_clusters!='5'){
#       metadata[i,]['group']='1'
#   }
# }

write.csv(metadata, file=paste0(dir2,'metadata_1.csv'), quote=F, row.names=F)

# write expression counts matrix
library(Matrix)
counts_matrix <- GetAssayData(mcv, assay='RNA', slot='counts')
writeMM(counts_matrix, file=paste0(dir2,'counts_1.mtx'))

# write dimensional reduction matrix, in this case harmony matrix. T
write.csv(mcv@reductions$harmony@cell.embeddings, file=paste0(dir2,'harmony_1.csv'), quote=F, row.names=F)


# write gene names
write.table(
  data.frame('gene'=rownames(counts_matrix)),file=paste0(dir2,'gene_names_1.csv'),
  quote=F,row.names=F,col.names=F
)


##rest run with python scVelo notebook:Figure_2_Code_github.ipynb

```




```{r}
##Colors used for seurat_cluster to be fed into scVelo

library(scales)

identities <- levels(mcv)

#Create vector of default ggplot2 colors
my_color_palette <- hue_pal()(length(identities))

```

```{r}
##plotting trajectory from cytopath onto the seurat umap. endpoint_1_trajectory_for_paper.csv was generated by cytopath in the python notebook: Figure_2_Code_github.ipynb
traj_1p=read.csv(paste0(dir2, '/endpoint_1_trajectory_for_paper.csv'))


traj_1p_start_end=data.frame(X=c(traj_1p$X[1], traj_1p$X[nrow(traj_1p)]), X0=c(traj_1p$X0[1], traj_1p$X0[nrow(traj_1p)]))

p<-DimPlot(mcv,reduction = "umap")+ NoAxes()
pdf(file="cytopath_1_trajectory.pdf", width=9, height = 5.5)
p+geom_path(data=traj_1p, mapping=aes(x=X, y=X0), color='black' )+geom_point(data=traj_1p_start_end, mapping=aes(x=X[1], y=X0[1]), shape=20, size=2, stroke=1, color='red')+geom_point(data=traj_1p_start_end, mapping=aes(x=X[2], y=X0[2]), shape=4, size=2, stroke=1, color='red')
dev.off()

```

